# Mac（公网）→ 阿里云 ECS 跳板机 → 反向 SSH 隧道 → 家里内网 Ubuntu 服务器（稳定版流程总结）

> 目标：在 **阿里云 ECS（8.130.171.106）没有公网 IPv6**、家里网络也可能 **无法入站** 的情况下，
> 通过“**家里服务器主动连阿里云建立反向隧道**”，让 Mac 能从公网稳定 SSH 回家。


## 0. 背景结论：为什么不能直接用 IPv6
在阿里云 ECS 上检查：
- `ip -6 addr` 只有 `fe80::`（链路本地 IPv6）
- `ip -6 route` 没有 `default`（没有 IPv6 默认路由）
- `ping6 ...` 报 `Network is unreachable`

结论：ECS **没有公网 IPv6 出口**，因此无法作为 “IPv6 跳板” 去访问家里 `2409:...`。

---

## 1. 总体方案（推荐）
**方案：反向 SSH 隧道（Reverse SSH Tunnel）**
- 由 **家里服务器主动 SSH 到阿里云 ECS**
- 在 ECS 上创建一个仅本机可访问的端口（例如 `127.0.0.1:2222`）
- Mac 通过 `ProxyJump` 先到 ECS，再连接 `localhost:2222`，最终进入家里服务器

链路：
Mac → (SSH) → Aliyun ECS → (ECS 本机 localhost:2222) → (反向隧道) → Home Ubuntu :22

---

## 2. 前置准备

### 2.1 阿里云 ECS（跳板机）准备
1) 确保能登录 ECS（建议仅密钥登录）
2) 确保 SSHD 允许端口转发（一般默认允许，但建议确认）

编辑 ECS 上：
- `/etc/ssh/sshd_config`

确认（没有就加上）：
```conf
AllowTcpForwarding yes
GatewayPorts no
````

重启 SSH 服务（Ubuntu 常用是 `ssh` 不是 `sshd`）：

```bash
sudo sshd -t
sudo systemctl restart ssh
```

> 说明：
>
> * `GatewayPorts no` 更安全：反向映射端口只监听在 ECS 本机 `127.0.0.1`，不暴露给公网。
> * 你遇到的 `systemctl restart sshd` 不存在，是因为 Ubuntu 通常是 `ssh.service`。

---

## 3. 家里 Ubuntu 服务器：建立反向隧道（临时手动版）

在家里服务器执行（fan 用户举例）：

```bash
ssh -i ~/.ssh/id_ed25519 -N \
  -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
  -o ExitOnForwardFailure=yes \
  -R 2222:localhost:22 root@8.130.171.106
```

含义：

* `-R 2222:localhost:22`：把“家里机器的 22 端口”映射到“阿里云 ECS 的 2222（本机监听）”
* `-N`：不执行远端命令，仅保持隧道
* `ExitOnForwardFailure=yes`：转发失败则退出（便于自动重启）
* `ServerAlive*`：降低 NAT/网络抖动导致的断线概率

### 3.1 在 ECS 上验证隧道是否已生效

在 ECS 上执行：

```bash
ss -lntp | grep 2222
```

期望看到类似：

* `127.0.0.1:2222` LISTEN
* 可能也会看到 `[::1]:2222` LISTEN（同样是本机回环）

---

## 4. Mac（公网）侧：通过 ProxyJump 连接回家

### 4.1 推荐写入 `~/.ssh/config`

示例（按你的实际配置）：

```sshconfig
Host alicloud-ecs-gateway
  HostName 8.130.171.106
  User root
  IdentityFile ~/.ssh/sailorvoyage-ecs-gateway.pem
  IdentitiesOnly yes
  ServerAliveInterval 60
  ServerAliveCountMax 3

Host home-ubuntu
  HostName 127.0.0.1
  User fan
  Port 2222
  ProxyJump alicloud-ecs-gateway
  ServerAliveInterval 60
  ServerAliveCountMax 3

Host *
  TCPKeepAlive yes
```

### 4.2 连接命令

```bash
ssh home-ubuntu
```

首次连接会提示 host key 确认（正常）：

* 这是因为对 Mac 来说，目标是 `[127.0.0.1]:2222`（经跳板代理）
* 输入 `yes` 即可写入 `known_hosts`

---

## 5. 关键注意事项（常见坑）

### 5.1 隧道必须“保持在线”

* 反向隧道是一条持续连接
* 一旦你在家里服务器按 `Ctrl+C` 断开，ECS 上的 2222 就立刻消失
* 表现为 Mac 侧报：

  * `connect failed: Connection refused`
  * `stdio forwarding failed`
  * `Connection closed ...`

因此需要“常驻 + 自动重连”。

---

## 6. 家里服务器：做成常驻自启（稳定版）

### 6.1 安装 autossh

```bash
sudo apt-get update
sudo apt-get install -y autossh
```

### 6.2 创建 systemd 服务（推荐）

```bash
sudo tee /etc/systemd/system/reverse-ssh.service >/dev/null <<'EOF'
[Unit]
Description=Reverse SSH tunnel to Aliyun ECS gateway
After=network-online.target
Wants=network-online.target

[Service]
User=fan
Environment="AUTOSSH_GATETIME=0"
ExecStart=/usr/bin/autossh -M 0 -N \
  -i /home/fan/.ssh/id_ed25519 \
  -o "ServerAliveInterval=30" -o "ServerAliveCountMax=3" \
  -o "ExitOnForwardFailure=yes" \
  -R 2222:localhost:22 root@8.130.171.106
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

启用并启动：

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now reverse-ssh.service
sudo systemctl status reverse-ssh.service --no-pager
```

### 6.3 验证

* ECS 上：

```bash
ss -lntp | grep 2222
```

* Mac 上：

```bash
ssh home-ubuntu
```

---

## 7. 安全建议（强烈推荐）

1. ECS 保持 `GatewayPorts no`，确保 2222 只监听在 `127.0.0.1`（外网不可直接访问）
2. ECS root 禁用密码登录，仅允许密钥
3. 家里服务器使用独立专用 key（可选）
4. 需要映射多台内网机器/多服务时，使用不同端口：

   * 2222 → home-ubuntu-1:22
   * 2223 → home-ubuntu-2:22
   * 8080/8443 → 内网 Web 服务（同理用 `-R` 映射）

---

## 8. 快速排障清单（最常用）

### Mac 连接报 Connection refused

* 去 ECS 检查：

```bash
ss -lntp | grep 2222 || echo "2222 not listening"
```

若没监听：说明家里隧道断了 → 重启 reverse-ssh.service 或重连

### 家里隧道起不来

* 家里执行带日志：

```bash
ssh -vv -i ~/.ssh/id_ed25519 -R 2222:localhost:22 root@8.130.171.106
```

常见原因：ECS 不允许转发 / key 没授权 / 网络断开

### ECS 重启 ssh 服务名找不到

* Ubuntu 通常是：

```bash
sudo systemctl restart ssh
```

---

## 9. 最终使用方式（日常操作）

1. 家里服务器 `reverse-ssh.service` 常驻运行
2. 你在任何地方用 Mac：

```bash
ssh home-ubuntu
```

即可从公网稳定回到家里服务器
