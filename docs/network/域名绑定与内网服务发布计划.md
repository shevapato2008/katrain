# 域名绑定与内网服务发布计划（sailorvoyage.top）

目标：将域名解析到阿里云 ECS，并通过反向 SSH 隧道把家中服务器的 8000/8001 服务安全地发布到公网。

## 0. 方案选择

当前采用 **WireGuard** 方案：ECS 通过 WG 内网访问家里服务，再由 Nginx 反代到公网域名。  
域名对应关系如下：  
- `api-go.sailorvoyage.top` → 家里 8000（KataGo 引擎）  
- `go.sailorvoyage.top` → 家里 8001（Katrain Web）

如果你希望切回反向 SSH（`127.0.0.1:18000/18001`），我会改成对应配置。

## 1. DNS 解析

执行位置：连接公网的 Macbook（浏览器登录阿里云控制台）

在域名控制台确认记录存在：
- A 记录：`api-go` → `8.130.171.106`
- A 记录：`go` → `8.130.171.106`

验证（解析生效前可能为空，命令在 Macbook 执行）：
```bash
dig +short api-go.sailorvoyage.top
```

## 2. ECS 安全组放行

执行位置：连接公网的 Macbook（浏览器登录阿里云控制台）

在 ECS 安全组放行端口：
- TCP 80（HTTP）
- TCP 443（HTTPS）
- TCP 22（建议仅你的公网 IP 允许）
- UDP 51820（WireGuard）

## 3. WireGuard 隧道检查

执行位置：阿里云 ECS + 家中局域网内的服务器 `home-ubuntu`

确认 WireGuard 接口与链路：
```bash
sudo wg show
ip -4 addr show wg0
```

从 ECS 测试家里服务连通性（按你的 WG 内网 IP 调整，例如 `10.8.0.2`）：
```bash
ping -c 3 10.8.0.2
curl -I http://10.8.0.2:8000
curl -I http://10.8.0.2:8001
```

如果 ping 不通，先排查 WG 配置、路由和防火墙。

## 4. ECS 安装并配置 Nginx

执行位置：阿里云 ECS

Nginx 作为反向代理，把公网域名请求转发到 WireGuard 内网中的家里服务（`10.8.0.2:8000/8001`）。

安装：
```bash
sudo apt-get update
sudo apt-get install -y nginx
```

创建配置（执行位置：阿里云 ECS，以下为当前已用配置样式；证书段由 Certbot 管理）：
```nginx
# /etc/nginx/sites-available/api-go.sailorvoyage.top
server {
  server_name api-go.sailorvoyage.top;
  include /etc/nginx/snippets/letsencrypt.conf;
  location = / { return 301 /docs; }
  location / {
    proxy_pass http://10.8.0.2:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;
  }
  listen 443 ssl; # managed by Certbot
  listen [::]:443 ssl ipv6only=on; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/api-go.sailorvoyage.top/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/api-go.sailorvoyage.top/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
server {
  if ($host = api-go.sailorvoyage.top) { return 301 https://$host$request_uri; } # managed by Certbot
  listen 80;
  listen [::]:80;
  server_name api-go.sailorvoyage.top;
  return 404; # managed by Certbot
}

# /etc/nginx/sites-available/go.sailorvoyage.top
server {
  server_name go.sailorvoyage.top;
  include /etc/nginx/snippets/letsencrypt.conf;
  include /etc/nginx/snippets/acme_logging.conf;
  location / {
    proxy_pass http://10.8.0.2:8001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;
  }
  listen 443 ssl; # managed by Certbot
  listen [::]:443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/api-go.sailorvoyage.top/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/api-go.sailorvoyage.top/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
server {
  if ($host = go.sailorvoyage.top) { return 301 https://$host$request_uri; } # managed by Certbot
  listen 80;
  listen [::]:80;
  server_name go.sailorvoyage.top;
  return 404; # managed by Certbot
}
```

启用并重载（执行位置：阿里云 ECS）：
```bash
sudo ln -s /etc/nginx/sites-available/api-go.sailorvoyage.top /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/go.sailorvoyage.top /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

Macbook 侧验证（执行位置：连接公网的 Macbook）：
```bash
curl -I http://api-go.sailorvoyage.top
curl -I http://go.sailorvoyage.top
```

## 5. 申请 HTTPS 证书

执行位置：阿里云 ECS

```bash
sudo apt-get install -y certbot python3-certbot-nginx
sudo certbot --nginx -d api-go.sailorvoyage.top -d go.sailorvoyage.top
```

Macbook 侧验证（执行位置：连接公网的 Macbook）：
```bash
curl -I https://api-go.sailorvoyage.top
curl -I https://go.sailorvoyage.top
```

## 6. 验证清单

- Macbook：`dig +short api-go.sailorvoyage.top` 返回 `8.130.171.106`
- Macbook（开代理时）：用 `dig +short api-go.sailorvoyage.top @8.8.8.8` 或 `@223.5.5.5` 避开代理 DNS
- ECS：`ping -c 3 10.8.0.2` 通
- ECS：`curl -I http://10.8.0.2:8000` 和 `curl -I http://10.8.0.2:8001` 有响应
- Macbook：`curl -I https://api-go.sailorvoyage.top` 返回 200/302
- Macbook（开代理时）：`curl --noproxy '*' -I https://api-go.sailorvoyage.top` 返回 200/302
- Macbook（开代理时）：`curl --noproxy '*' -I https://go.sailorvoyage.top` 返回 200/302

## 7. 可选加固

- 阿里云 ECS：Nginx Basic Auth
- 阿里云 ECS：仅白名单 IP 可访问
- home-ubuntu：WireGuard 使用专用密钥 + 最小化可访问网段
