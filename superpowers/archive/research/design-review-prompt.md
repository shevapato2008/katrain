# 设计文档审核 Prompt

## 背景

我正在开发一个围棋 AI 分析 Web 应用（KaTrain Galaxy），需要重构其中的"研究"模块。该应用的技术栈为：FastAPI + React/TypeScript + PostgreSQL + KataGo AI 引擎。

我参考了星阵围棋（商业围棋 AI 平台）的"研究"功能，设计了一个两级页面架构。现在需要你审核这份设计文档，找出潜在的问题、遗漏和改进空间。

---

## 需求摘要

### 核心目标

将现有的单一研究页面重构为两级页面：

1. **Level 1（研究准备）**：纯前端棋盘编辑页面，不连接任何 AI 引擎。用户可以：
   - 自由摆棋（支持黑白交替、连续摆黑、连续摆白三种模式）
   - 编辑棋盘（移动棋子、删除棋子、清空、停一手）
   - 从本地上传 SGF 棋谱文件
   - 从云端棋谱库加载棋谱（个人棋谱 / 个人盘面 / 公共大赛棋谱）
   - 保存棋谱（下载到本地 / 保存到数据库）
   - 设置规则参数（棋盘大小、规则、贴目、让子）

2. **Level 2（AI 分析）**：在 Level 1 的棋局基础上启动 KataGo 分析。用户可以：
   - 查看 AI 推荐着法（hints）、领地评估（ownership）、评价点（eval）
   - 查看分析面板：Top moves 列表（坐标、推荐度、子差、胜率）
   - 查看走势图 / 妙手列表 / 问题手列表（三个 Tab 切换）
   - 继续落子和编辑棋盘（保留 Level 1 的所有摆子工具）
   - 浏览棋谱（导航栏前进/后退/跳转）

### 明确排除的功能
- 不需要计时收费
- 不需要停止计算按钮
- 不需要 Policy 热力图

### 技术约束
- Level 1 和 Level 2 在同一个路由（`/galaxy/research`）内通过状态切换，不使用路由导航
- Level 1 使用 `LiveBoard` 组件（纯前端客户端棋盘，不连接后端）
- Level 2 使用现有的 Legacy `Board` 组件 + `useGameSession` hook（通过 WebSocket 连接后端 KataGo session）
- "返回编辑"按钮放在棋盘区域右上角（参考对弈模块的"退出"按钮位置）
- 工具栏在 Level 1 和 Level 2 中是同一个共用组件

### 数据库变更
- 删除现有的 `games` 表（原用于 PvP 对弈记录，测试阶段无历史包袱）
- 新建 `user_games` 表（统一的个人棋谱库）和 `user_game_analysis` 表（逐手分析数据）
- `rating_history` 表的外键改为指向 `user_games`
- 所有权模型：人机对弈产生 1 条记录，人人对弈为双方各产生 1 条记录

### 参考系统
- 星阵围棋"研究"功能（两级页面交互范本）
- 本项目现有的"直播"模块（同样采用两级页面：列表页 → 详情页）
- 本项目现有的"对弈"模块（右侧面板布局、工具栏位置的参考）

---

## 设计文档

（见附件：`2026-02-01-research-module-redesign.md`）

---

## 审核要求

请从以下维度审核这份设计文档，并给出具体的改进建议：

### 1. 架构合理性
- Level 1 用 LiveBoard（客户端棋盘）、Level 2 切换到 Legacy Board（服务端 GameState）的方案是否合理？切换时是否存在状态丢失或不一致的风险？
- 同一路由内状态切换 vs 两个独立路由，这个选择是否会带来问题？
- `useGameSession` hook 原本是为对弈设计的，复用它来做研究分析是否合适？有哪些潜在兼容性问题？

### 2. 数据库设计
- `user_games` 表的字段设计是否完整？是否有遗漏的字段？
- `user_game_analysis` 表与现有 `live_analysis` 表结构对齐的做法是否合理？两张表未来是否应该合并为一张通用分析表？
- 删除 `games` 表并用 `user_games` 替代的迁移策略是否干净？`rating_history` 的外键迁移是否有风险？
- 所有权模型（人人对弈双方各一条）是否会导致数据冗余问题？SGF 内容重复存储是否需要优化？

### 3. 前端组件设计
- ResearchToolbar 作为 L1/L2 共用组件，在两种模式下按钮的激活/置灰逻辑是否清晰？
- L1→L2 转换时 `moves[]` 序列化为 SGF 的过程是否有边界情况需要处理（比如非标准摆子顺序、连续同色棋子）？
- L2→L1 转换时从 GameState 恢复 `moves[]` 是否可靠？GameState 中是否总能提取完整的着法序列？
- 棋谱库模态框的分类设计（我的棋谱/我的盘面/公共棋谱）是否合理？

### 4. API 设计
- `/api/v1/user-games` 的 CRUD 接口是否完整？是否需要批量操作？
- 分析数据 API 的粒度是否合适？
- 是否需要考虑权限控制（只能访问自己的棋谱）？

### 5. 实现阶段划分
- 8 个 Phase 的依赖关系是否正确？
- 是否有可以合并或重新排序以加快交付的阶段？
- MVP 最小可用版本应该包含哪些 Phase？

### 6. 遗漏和风险
- 是否有我没考虑到的边界情况或用户场景？
- 是否有技术风险点需要提前验证（prototype/spike）？
- 与现有模块（对弈、直播、棋谱库）的集成是否有冲突？

---

## 输出格式

请按以下格式输出审核结果：

```
## 总体评价
（一段话概述设计质量）

## 关键问题（必须修复）
1. [问题描述] → [建议修复方案]
2. ...

## 改进建议（推荐但非必须）
1. [建议描述] → [具体方案]
2. ...

## 遗漏补充
1. [遗漏点] → [补充建议]
2. ...

## Phase 优化建议
（对实现阶段的调整建议）
```
