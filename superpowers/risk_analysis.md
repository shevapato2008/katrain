# Galaxy Go UI - 风险分析

> 日期: 2026-01-20
> 更新: 增加深度分析后新发现的风险

## 高风险项

### 1. 人人对弈后端复杂度
- **风险**: 后端API和WebSocket机制尚未实现
- **影响**: P5可能延期或功能受限
- **可能性**: 高
- **缓解措施**:
  - 前端先用Mock数据完成UI
  - 后端API设计文档先行
  - 考虑使用现有WebSocket扩展（如Socket.io）
- **责任人**: 需要后端开发支持

### 2. 路由状态管理
- **风险**: 从对弈页面切换到其他页面时，游戏状态可能丢失
- **影响**: 用户体验差，可能丢失进行中的对局
- **可能性**: 中
- **缓解措施**:
  - 使用React Context持久化游戏状态
  - WebSocket连接保持在顶层
  - 提供"继续对局"入口
- **技术验证**: P1阶段需做POC

### 3. 现有App.tsx耦合度
- **风险**: 现有代码将认证、游戏、UI状态混合在一起
- **影响**: 难以分离出独立的Galaxy UI
- **可能性**: 中
- **详细分析**:
  - App.tsx包含675行代码，状态管理复杂
  - token、sessionId、gameState等状态紧密耦合
  - WebSocket连接在useEffect中初始化，与sessionId绑定
- **缓解措施**:
  - 两套UI并存，通过路由隔离
  - 共享API层和Context
  - 渐进式迁移

### 4. [新增] AI级别体系不一致
- **风险**: 星阵有31级AI，KaTrain使用不同的AI策略体系
- **影响**: 用户体验可能与预期不符
- **可能性**: 中
- **详细分析**:
  - KaTrain的AI策略包括Calibrated Rank、Simple Rank、Scoreloss等
  - 星阵的31级AI声称"下法与该水平人类相似"
  - 两套体系映射可能不准确
- **缓解措施**:
  - 使用KaTrain现有体系，不做映射
  - 或创建新的级别命名（如"初学者"、"爱好者"、"高手"）
  - 明确说明级别为近似值
- **决策待定**: 见open_questions.md #1

---

## 中风险项

### 5. 观战WebSocket广播
- **风险**: 需要支持多个观众同时连接同一对局
- **影响**: P5观战功能实现
- **可能性**: 中
- **缓解措施**:
  - 使用房间模式WebSocket
  - 限制观众人数上限
  - 观众只接收不发送

### 6. AI定级算法准确性
- **风险**: 3盘定级可能不够准确
- **影响**: 用户匹配体验
- **可能性**: 中
- **缓解措施**:
  - 初始段位偏保守
  - 提供快速升降级机制
  - 后续可增加定级盘数

### 7. 移动端适配
- **风险**: 棋盘在小屏幕上的交互困难
- **影响**: 移动用户体验
- **可能性**: 中
- **缓解措施**:
  - P6再做移动端
  - 先确保PC端体验
  - 棋盘支持缩放

### 8. [新增] 道具系统与现有功能重叠
- **风险**: 星阵的"道具"概念与KaTrain已有功能重叠
- **影响**: UI设计和交互逻辑
- **可能性**: 低-中
- **详细分析**:
  - KaTrain已有Ownership显示（=领地道具）
  - KaTrain已有Top Moves显示（=支招道具）
  - KaTrain已有变化图显示（=变化图道具）
- **缓解措施**:
  - 复用现有功能，仅在人人对弈时添加使用次数限制
  - 或完全不引入"道具"概念，保持KaTrain的自由分析风格
- **决策待定**: 见open_questions.md #2

### 9. [新增] 对局类型区分复杂度
- **风险**: 自由战/升降战的区分增加后端和前端复杂度
- **影响**: 数据库设计、API设计、UI逻辑
- **可能性**: 中
- **详细分析**:
  - 需要在对局记录中标记类型
  - 升降战需要段位变更逻辑
  - 前端需要显示不同的对局入口和结果
- **缓解措施**:
  - 初期只实现自由战
  - 升降战作为后续版本功能
- **决策待定**: 见open_questions.md #6

---

## 低风险项

### 10. i18n翻译覆盖
- **风险**: 新增文本可能缺少翻译
- **影响**: 非中文用户体验
- **可能性**: 低
- **缓解措施**:
  - 开发时标记新i18n key
  - P6统一处理翻译

### 11. 设计风格偏差
- **风险**: 新组件与Zen Mode风格不一致
- **影响**: 视觉体验割裂
- **可能性**: 低 (已确认复用现有主题)
- **缓解措施**:
  - 所有新组件使用现有MUI主题
  - 不引入新的设计语言
  - 代码审查时检查风格一致性

### 12. [新增] 快捷键冲突
- **风险**: 星阵快捷键与KaTrain或浏览器默认冲突
- **影响**: 用户操作不便
- **可能性**: 低
- **详细分析**:
  - KaTrain已有useKeyboardShortcuts
  - 星阵快捷键可能与现有定义冲突
- **缓解措施**:
  - 保持KaTrain现有快捷键体系
  - Galaxy UI研究模式可选对齐星阵
- **决策待定**: 见open_questions.md #8

---

## 依赖项清单

| 依赖 | 所需阶段 | 状态 | 阻塞程度 |
|------|----------|------|----------|
| React Router v6 | P1 | 需安装 | 阻塞 |
| 现有认证API | P2 | 已有 | - |
| 现有Board组件 | P3-P5 | 已有 | - |
| AI定级API | P4 | **需开发** | 阻塞P4 |
| 人人对弈API | P5 | **需开发** | 阻塞P5 |
| WebSocket房间支持 | P5 | **需开发** | 阻塞P5观战 |
| [新增] 用户数据持久化 | P4+ | **需设计** | 影响棋谱库 |
| [新增] 社交功能API | P5 | **可选** | 非阻塞 |

---

## 现有KaTrain资产可复用分析

### 可直接复用 (低风险)
| 组件/功能 | 文件 | 复用方式 |
|-----------|------|----------|
| 棋盘渲染 | Board.tsx | 作为子组件引入 |
| 分析面板 | AnalysisPanel.tsx | 研究模式复用 |
| 胜率图 | ScoreGraph.tsx | 研究模式复用 |
| 控制栏 | ControlBar.tsx | 样式调整后复用 |
| 玩家卡片 | PlayerCard.tsx | 对弈模式复用 |
| MUI主题 | App.tsx:22-98 | **提取为独立theme.ts** |
| API封装 | api.ts | 直接复用 |
| i18n系统 | i18n.ts | 直接复用 |
| 键盘快捷键 | useKeyboardShortcuts.ts | 扩展复用 |

### 需要修改后复用 (中风险)
| 组件/功能 | 文件 | 修改内容 |
|-----------|------|----------|
| 新游戏对话框 | NewGameDialog.tsx | 拆分为AI设置和匹配设置 |
| AI设置 | AISettingsDialog.tsx | 适配Galaxy UI布局 |
| 游戏报告 | GameReportDialog.tsx | 对局结束流程整合 |
| 侧边栏 | Sidebar.tsx | 完全重写为GalaxySidebar |

### 需要新建 (高投入)
| 功能 | 说明 |
|------|------|
| 路由系统 | AppRouter.tsx + MainLayout.tsx |
| Dashboard | 模块卡片首页 |
| PlayMenu | 对弈模式选择 |
| HumanVsHumanLobby | 大厅UI (Mock) |
| GameRoom | 房间系统UI (Mock) |
| AuthGuard | 登录保护 |
| AuthContext | 认证状态管理 |
| GameContext | 游戏状态管理 |

---

## 建议的阶段性验证

### P1验证点
- [ ] 两套UI路由隔离正常
- [ ] 共享状态（token、session）可跨UI访问
- [ ] 新组件风格与现有一致
- [ ] [新增] MUI主题成功提取为独立文件

### P2验证点
- [ ] 登录状态在Galaxy UI中正常
- [ ] 侧边栏导航功能完整
- [ ] AuthGuard正确拦截未登录用户

### P3验证点
- [ ] 研究模式正确要求登录
- [ ] 现有Board组件在新布局中正常工作
- [ ] SGF加载/保存功能正常

### P4验证点
- [ ] AI定级流程完整
- [ ] 人机对弈全流程正常
- [ ] 对局结束处理正确
- [ ] [新增] 对局记录持久化（如需要）

### P5验证点
- [ ] Mock数据驱动的大厅UI
- [ ] (如后端就绪) 真实匹配流程
- [ ] (如后端就绪) 观战功能
- [ ] [新增] WebSocket广播正常

---

## 回退方案

如果Galaxy UI开发遇到严重阻塞：

1. **P1-P2阻塞**: 重新评估架构方案
2. **P3阻塞**: 研究模式可直接复用现有UI
3. **P4阻塞**: 人机对弈可复用现有NewGameDialog流程
4. **P5阻塞**: 人人对弈推迟到下一版本，先上线P1-P4

**底线**: 即使P5未完成，P1-P4已经提供了完整的单人体验。

---

## 决策依赖关系图

```
open_questions.md 待确认
        ↓
┌───────┴───────┐
│               │
#1 AI级别   #6 对局类型
    ↓           ↓
P4 人机对弈  P5 人人对弈
    ↓           ↓
#2 道具系统     │
    ↓           │
┌───┴───┐       │
保留/不保留     │
    ↓           │
P5 人人对弈 ←───┘
```

建议优先确认 #1、#6 后再深入 P4、P5 的详细设计。
