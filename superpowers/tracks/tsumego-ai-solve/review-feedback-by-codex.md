# AI Tsumego Solver 方案评审反馈（Codex）

## 1. Critical issues（需修改后再实施）
- 导航重构缺少兼容路径：现有 `/galaxy/tsumego` 直接落到习题列表，变更为 hub 后需提供至少一个 `Navigate/Redirect`（或服务器 301）以避免旧书签、站内链接、SEO 失效，特别是问题详情页入口。
- 坐标/区域校验未定义：`region` 及棋盘坐标需要在后端验证边界、x1≤x2、y1≤y2、尺寸匹配 board_size，并在请求前统一做 y 轴翻转，避免前后端两处各自处理造成偏差。
- 端点设计重复：新增 `/tsumego-solve` 与现有 `/quick-analyze` 行为高度重叠。若不复用公共服务层/HTTP 客户端，易产生两套默认值、超时和错误处理不一致。建议复用同一服务函数并仅扩展 `regionBounds` 支持。
- 资源/性能默认值风险：`max_visits=10000` 可能导致 9x9/13x13 场景卡顿；需根据棋盘大小或“快速/深入”模式限制访次并设置后端超时与前端取消/重试机制。
- 错误处理缺口：计划未说明 KataGo 超时、HTTP 失败、非法局面等错误的用户提示与重试策略；需要统一的 Loading/Retry/Toast 流程以防页面无响应。

## 2. Suggestions（改进项）
- 抽象共享组件：从 `ResearchToolbar/Board` 提炼通用的棋盘编辑工具与工具按钮，AI Solver 仅组合配置，减少重复和后续维护成本。
- 区域自动推断优化：提供“全局分析”选项；自动区域时允许用户调节边距（0/1/2）并在发送前可视化校验，避免 vital point 落在框外。
- 导入/导出：优先支持 SGF 粘贴或上传；同时允许从现有题库页面“一键发送到 AI 解题”，复用题面设置。
- 触控与可访问性：矩形绘制需支持移动端长按/拖拽；提供键盘操作或按钮式设置区域以兼顾无鼠标场景。
- 结果呈现：除标记前 5 步外，提供 PV 序列（可展开/收起），并在鼠标 hover 时显示幽灵棋子；允许切换显示胜率/目数。
- 客户端缓存：同一局面+参数返回一致结果，可按局面哈希缓存以减少重复请求。
- Backend HTTP 客户端复用：在 FastAPI 启动时创建 `httpx.AsyncClient`（含连接池、超时、重试/backoff），避免每次请求新建客户端。

## 3. Questions（需澄清）
- 是否需要保留对外可共享的旧路由（例如题目详情页深链接）？若需要，是否有站外引用需要 301 而非前端 redirect？
- 端点是否需要 auth/速率限制？AI 解题开放调用可能被滥用导致 KataGo 过载。
- 规则与参数默认值：默认规则/贴目是否应随题库（如日式、规则）或棋盘尺寸自动切换？
- 非法棋面处理：期待行为是报错提示还是自动清理禁入点/自杀？是否需要本地合法性校验以减少失败请求？
- 目标设备占比：若移动端占比较高，是否需要优先实现触控矩形绘制与响应式侧栏折叠？

## 4. Approval
- 状态：Needs revision（需根据上述 Critical issues 调整后再开工）。
