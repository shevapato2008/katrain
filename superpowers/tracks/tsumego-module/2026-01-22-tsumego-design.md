# Tsumego (死活题) Module Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a self-learning Tsumego practice module for KaTrain Galaxy Go web UI, allowing users to browse problems by difficulty/category, solve them interactively, and track progress.

**Architecture:** SGF files organized by difficulty level, parsed to extract metadata into index.json and synced to database. Frontend displays problem thumbnails in grid, solving page uses guided interaction mode (auto-respond on correct, hint on wrong). Progress stored in localStorage for guests, synced to server for logged-in users.

**Tech Stack:** FastAPI (backend), React + TypeScript + MUI (frontend), SQLAlchemy (ORM), existing SGF parser (`katrain/core/sgf_parser.py`), existing Board component.

---

## Design Summary

### Navigation Structure
```
Galaxy Sidebar
├── Play
├── Research
├── Tsumego ← NEW
│   └── /galaxy/tsumego              → Difficulty selection
│   └── /galaxy/tsumego/:level       → Category selection
│   └── /galaxy/tsumego/:level/:cat  → Problem list (thumbnails)
│   └── /galaxy/tsumego/problem/:id  → Solving page
```

### Data Organization
- Problem ID = filename (e.g., "1014"), decoupled from difficulty level
- Problems can be moved between levels without losing user progress
- Index generated by script, synced to database

### Core Interaction (Guided Mode)
1. User plays move → check against SGF variation tree
2. Correct + has continuation → AI auto-responds after 300ms
3. Correct + terminal node with "恭喜答对" → Success!
4. Wrong/no match → Show error, allow undo

### Progress Tracking
- Per problem: completed, attempts, firstCompletedAt, lastAttemptAt, lastDuration
- localStorage for guests, database for logged-in users
- Merge on login

### Visual Design (Galaxy Theme)
```
Background:      #0f0f0f
Card background: rgba(255,255,255,0.05)
Primary accent:  #e89639 (amber/gold)
Success:         #4caf50 (green)
Error:           #e16b5c (red)
Text primary:    #f5f3f0
Text secondary:  #7a7772
```

### Thumbnail Card States
```
Completed         In Progress       Not Started
┌───────────┐    ┌───────────┐    ┌───────────┐
│  [board]  │    │  [board]  │    │  [board]  │
│   第3题   │    │   第5题   │    │   第7题   │
│ ⚡12秒 ×2 │    │      ×3   │    │           │
└───────────┘    └───────────┘    └───────────┘
  green border    orange border    gray border
```

### Responsive Layout

**Desktop (>1024px):**
```
┌──────────────────────────────────────────────────┐
│ [Board 60%]              [Controls 40%]          │
│ ┌────────────────────┐   ┌────────────────────┐  │
│ │                    │   │ 3D - 死活题 - #12   │  │
│ │                    │   │ ● 黑先              │  │
│ │      Go Board      │   │                    │  │
│ │    (auto-crop)     │   │ Status: 请落子      │  │
│ │                    │   │                    │  │
│ │                    │   │ [悔棋] [重做] [提示] │  │
│ │                    │   │ [◀ 上一题] [下一题 ▶]│  │
│ └────────────────────┘   └────────────────────┘  │
└──────────────────────────────────────────────────┘
```

**Mobile (<768px):**
```
┌─────────────────────┐
│ 3D • #12 of 354     │
│ ● 黑先              │
├─────────────────────┤
│                     │
│      [Board]        │
│                     │
├─────────────────────┤
│ [◀] [悔棋] [重做] [▶] │
└─────────────────────┘
```

### Animation Specifications
| Element | Animation | Duration |
|---------|-----------|----------|
| Stone placement | Scale 0.8 → 1.0 | 150ms |
| Wrong move | Red flash + shake | 300ms |
| AI response | Delay before placing | 300ms |
| Success | Confetti/sparkle | 1000ms |
| Card hover | Scale 1.0 → 1.02 + shadow | 200ms |

---

## Phase 1: Foundation (Browsable Problem Library)

### Task 1.1: Update .gitignore

**Files:**
- Modify: `.gitignore`

**Step 1: Add exception for life-n-death data**

```diff
# Local data
**/data/
+!data/life-n-death/
```

**Step 2: Verify data is now tracked**

Run: `git status data/life-n-death/`
Expected: Shows untracked files in 3D/ and 4D/

**Step 3: Commit**

```bash
git add .gitignore data/life-n-death/
git commit -m "chore: track tsumego SGF data in version control"
```

---

### Task 1.2: Create Index Generation Script

**Files:**
- Create: `scripts/generate_tsumego_index.py`

**Step 1: Write the script**

```python
#!/usr/bin/env python3
"""
Scan data/life-n-death/ directory and generate index.json

Usage: python scripts/generate_tsumego_index.py
"""

import json
import sys
from pathlib import Path

# Add project root to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from katrain.core.sgf_parser import SGF


DATA_DIR = Path("data/life-n-death")
OUTPUT_FILE = DATA_DIR / "index.json"


def parse_category(comment: str) -> str:
    """Extract problem type from SGF comment."""
    if "手筋" in comment:
        return "tesuji"
    elif "官子" in comment:
        return "endgame"
    else:
        return "life-death"


def extract_metadata(sgf_path: Path, level: str) -> dict:
    """Extract problem metadata from SGF file."""
    root = SGF.parse_file(str(sgf_path))

    problem_id = sgf_path.stem
    comment = root.get_property("C", "") or ""
    gc = root.get_property("GC", "") or ""
    pl = root.get_property("PL", "B") or "B"

    return {
        "id": problem_id,
        "level": level.lower(),
        "category": parse_category(comment + gc),
        "hint": "黑先" if pl.upper() == "B" else "白先",
        "boardSize": root.board_size[0],
        "initialBlack": root.get_list_property("AB", []),
        "initialWhite": root.get_list_property("AW", []),
        "source": root.get_property("SO", ""),
    }


def generate_index():
    """Generate index.json from SGF files."""
    index = {"levels": {}, "problems": {}}

    for level_dir in sorted(DATA_DIR.iterdir()):
        if not level_dir.is_dir() or level_dir.name.startswith("."):
            continue

        level = level_dir.name.lower()
        index["levels"][level] = {"categories": {}}

        for sgf_file in sorted(level_dir.glob("*.sgf")):
            try:
                meta = extract_metadata(sgf_file, level)
            except Exception as e:
                print(f"  ERROR parsing {sgf_file}: {e}")
                continue

            problem_id = meta["id"]
            category = meta["category"]

            # Add to problems dict (by ID)
            index["problems"][problem_id] = meta

            # Add to levels structure (by level/category)
            if category not in index["levels"][level]["categories"]:
                index["levels"][level]["categories"][category] = []
            index["levels"][level]["categories"][category].append(problem_id)

    # Write output
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(index, f, ensure_ascii=False, indent=2)

    # Summary
    print(f"Generated {OUTPUT_FILE}")
    for level, data in index["levels"].items():
        total = sum(len(ids) for ids in data["categories"].values())
        cats = ", ".join(f"{k}:{len(v)}" for k, v in data["categories"].items())
        print(f"  {level.upper()}: {total} problems ({cats})")
    print(f"  Total: {len(index['problems'])} problems")


if __name__ == "__main__":
    generate_index()
```

**Step 2: Run the script**

Run: `python scripts/generate_tsumego_index.py`
Expected:
```
Generated data/life-n-death/index.json
  3d: 354 problems (life-death:X, tesuji:Y, ...)
  4d: 642 problems (...)
  Total: 996 problems
```

**Step 3: Verify index.json**

Run: `head -50 data/life-n-death/index.json`
Expected: Valid JSON with levels and problems structure

**Step 4: Commit**

```bash
git add scripts/generate_tsumego_index.py data/life-n-death/index.json
git commit -m "feat: add tsumego index generation script"
```

---

### Task 1.3: Create Database Models

**Files:**
- Create: `katrain/web/core/models/tsumego.py`
- Modify: `katrain/web/core/models/__init__.py` (if exists, else create)

**Step 1: Write the models**

```python
"""Tsumego (life-and-death problem) database models."""

from datetime import datetime
from sqlalchemy import (
    Column, Integer, String, Text, Boolean, DateTime,
    ForeignKey, Index, JSON
)
from sqlalchemy.orm import relationship

from katrain.web.core.database import Base


class TsumegoProblem(Base):
    """Individual tsumego problem."""
    __tablename__ = "tsumego_problems"

    id = Column(String(32), primary_key=True)  # Problem number, e.g. "1014"
    level = Column(String(8), nullable=False, index=True)  # "3d", "4d"
    category = Column(String(32), nullable=False, index=True)  # "life-death", "tesuji"
    hint = Column(String(16), nullable=False)  # "黑先", "白先"
    board_size = Column(Integer, default=19)
    initial_black = Column(JSON)  # ["pa", "rd", ...]
    initial_white = Column(JSON)  # ["nc", "qf", ...]
    sgf_content = Column(Text)  # Full SGF for solving
    source = Column(String(256))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    __table_args__ = (
        Index("ix_tsumego_level_category", "level", "category"),
    )


class UserTsumegoProgress(Base):
    """User's progress on a specific problem."""
    __tablename__ = "user_tsumego_progress"

    user_id = Column(Integer, ForeignKey("users.id"), primary_key=True)
    problem_id = Column(String(32), ForeignKey("tsumego_problems.id"), primary_key=True)
    completed = Column(Boolean, default=False)
    attempts = Column(Integer, default=0)
    first_completed_at = Column(DateTime)
    last_attempt_at = Column(DateTime)
    last_duration = Column(Integer)  # Seconds to complete last time

    user = relationship("User", back_populates="tsumego_progress")
    problem = relationship("TsumegoProblem")
```

**Step 2: Update User model to add relationship**

In `katrain/web/core/models/user.py`, add:
```python
# Add to imports
from sqlalchemy.orm import relationship

# Add to User class
tsumego_progress = relationship("UserTsumegoProgress", back_populates="user")
```

**Step 3: Run migrations / create tables**

Run: `python -c "from katrain.web.core.database import engine, Base; from katrain.web.core.models.tsumego import *; Base.metadata.create_all(engine)"`

**Step 4: Commit**

```bash
git add katrain/web/core/models/
git commit -m "feat: add tsumego database models"
```

---

### Task 1.4: Create Database Sync Script

**Files:**
- Create: `scripts/sync_tsumego_db.py`

**Step 1: Write the script**

```python
#!/usr/bin/env python3
"""
Sync data/life-n-death/ SGF files to database.

Usage:
  python scripts/sync_tsumego_db.py --dry-run  # Preview changes
  python scripts/sync_tsumego_db.py            # Apply changes
"""

import argparse
import sys
from datetime import datetime
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from sqlalchemy.orm import Session
from katrain.web.core.database import engine, Base
from katrain.web.core.models.tsumego import TsumegoProblem
from katrain.core.sgf_parser import SGF


DATA_DIR = Path("data/life-n-death")


def parse_category(comment: str) -> str:
    if "手筋" in comment:
        return "tesuji"
    elif "官子" in comment:
        return "endgame"
    return "life-death"


def parse_sgf_file(sgf_path: Path, level: str) -> dict:
    """Parse SGF file and return problem data."""
    with open(sgf_path, "r", encoding="utf-8") as f:
        sgf_content = f.read()

    root = SGF.parse_sgf(sgf_content)
    comment = (root.get_property("C", "") or "") + (root.get_property("GC", "") or "")
    pl = root.get_property("PL", "B") or "B"

    return {
        "id": sgf_path.stem,
        "level": level.lower(),
        "category": parse_category(comment),
        "hint": "黑先" if pl.upper() == "B" else "白先",
        "board_size": root.board_size[0],
        "initial_black": root.get_list_property("AB", []),
        "initial_white": root.get_list_property("AW", []),
        "sgf_content": sgf_content,
        "source": root.get_property("SO", ""),
    }


def sync_database(dry_run: bool = False):
    """Sync SGF files to database."""
    # Collect all SGF files
    sgf_data = {}
    for level_dir in DATA_DIR.iterdir():
        if not level_dir.is_dir() or level_dir.name.startswith("."):
            continue
        for sgf_file in level_dir.glob("*.sgf"):
            try:
                data = parse_sgf_file(sgf_file, level_dir.name)
                sgf_data[data["id"]] = data
            except Exception as e:
                print(f"  ERROR: {sgf_file}: {e}")

    print(f"Found {len(sgf_data)} SGF files")

    # Ensure tables exist
    Base.metadata.create_all(engine)

    stats = {"inserted": 0, "updated": 0, "unchanged": 0, "orphaned": []}

    with Session(engine) as db:
        existing = {p.id: p for p in db.query(TsumegoProblem).all()}

        for problem_id, data in sgf_data.items():
            if problem_id in existing:
                record = existing[problem_id]
                needs_update = (
                    record.level != data["level"] or
                    record.category != data["category"] or
                    record.sgf_content != data["sgf_content"]
                )
                if needs_update:
                    if not dry_run:
                        for key, value in data.items():
                            setattr(record, key, value)
                        record.updated_at = datetime.utcnow()
                    stats["updated"] += 1
                    print(f"  UPDATE: {problem_id} (level: {record.level} → {data['level']})")
                else:
                    stats["unchanged"] += 1
            else:
                if not dry_run:
                    db.add(TsumegoProblem(**data))
                stats["inserted"] += 1
                print(f"  INSERT: {problem_id} ({data['level']}/{data['category']})")

        # Check orphans
        for problem_id in existing:
            if problem_id not in sgf_data:
                stats["orphaned"].append(problem_id)
                print(f"  WARNING: {problem_id} in DB but no SGF file")

        if not dry_run:
            db.commit()

    print(f"\nSync {'(DRY RUN) ' if dry_run else ''}complete:")
    print(f"  Inserted: {stats['inserted']}")
    print(f"  Updated: {stats['updated']}")
    print(f"  Unchanged: {stats['unchanged']}")
    if stats["orphaned"]:
        print(f"  Orphaned: {len(stats['orphaned'])} (not auto-deleted)")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--dry-run", action="store_true", help="Preview changes only")
    args = parser.parse_args()
    sync_database(dry_run=args.dry_run)
```

**Step 2: Test with dry-run**

Run: `python scripts/sync_tsumego_db.py --dry-run`
Expected: Shows INSERT for all ~996 problems

**Step 3: Run actual sync**

Run: `python scripts/sync_tsumego_db.py`
Expected: Inserts all problems into database

**Step 4: Commit**

```bash
git add scripts/sync_tsumego_db.py
git commit -m "feat: add tsumego database sync script"
```

---

### Task 1.5: Create Problem Library README

**Files:**
- Create: `data/life-n-death/README.md`

**Step 1: Write the documentation**

```markdown
# 死活题题库管理

## 目录结构

```
data/life-n-death/
├── 3D/              # 3段难度题目
│   ├── 1014.sgf
│   └── ...
├── 4D/              # 4段难度题目
│   └── ...
├── index.json       # 自动生成的索引文件
└── README.md        # 本文件
```

## SGF文件规范

```sgf
(;GM[1]FF[4]CA[UTF-8]SZ[19]
GN[Q-1014]                    ; 题目编号（文件名应与此一致）
C[黑先 死活题]                 ; 提示，包含"手筋"/"官子"可自动识别题型
AB[pa][rd][pb]...             ; 黑子初始位置
AW[nc][qf][oa]...             ; 白子初始位置
PL[B]                         ; 先手方 B=黑先 W=白先
SO[https://...]               ; 来源（可选）

(;B[qd]...C[恭喜答对])         ; 正确变化
(;B[ka]...C[失败，重来吧])      ; 错误变化
)
```

## 日常操作

### 添加新题目

1. 将SGF文件放入对应难度目录（如 `3D/1234.sgf`）
2. 运行同步脚本：
   ```bash
   python scripts/generate_tsumego_index.py
   python scripts/sync_tsumego_db.py --dry-run
   python scripts/sync_tsumego_db.py
   ```

### 调整题目难度

1. 移动文件：`mv data/life-n-death/3D/1014.sgf data/life-n-death/4D/`
2. 运行同步脚本
3. 用户进度自动保留（按题号追踪）

### 批量添加新难度

1. 创建目录：`mkdir data/life-n-death/5D`
2. 放入SGF文件
3. 运行同步脚本

## 题型自动识别

| 关键词 | 分类 | 标识 |
|--------|------|------|
| 手筋 | 手筋题 | tesuji |
| 官子 | 官子题 | endgame |
| 其他 | 死活题 | life-death |

## 注意事项

- **题号唯一**：不同难度目录下不要有相同文件名
- **编码格式**：UTF-8
- **Git提交**：修改后记得提交 index.json
```

**Step 2: Commit**

```bash
git add data/life-n-death/README.md
git commit -m "docs: add tsumego data management README"
```

---

### Task 1.6: Create Backend API Endpoints

**Files:**
- Create: `katrain/web/api/v1/endpoints/tsumego.py`
- Modify: `katrain/web/api/v1/api.py`

**Step 1: Write the API endpoints**

```python
"""Tsumego API endpoints."""

import json
from pathlib import Path
from typing import Optional, List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from pydantic import BaseModel

from katrain.web.core.database import get_db
from katrain.web.core.models.tsumego import TsumegoProblem, UserTsumegoProgress
from katrain.web.core.auth import get_current_user_optional, get_current_user
from katrain.web.core.models.user import User


router = APIRouter()

DATA_DIR = Path("data/life-n-death")
INDEX_FILE = DATA_DIR / "index.json"


# Response models
class LevelInfo(BaseModel):
    level: str
    categories: dict[str, int]  # category -> count
    total: int

class CategoryInfo(BaseModel):
    category: str
    name: str
    count: int

class ProblemSummary(BaseModel):
    id: str
    level: str
    category: str
    hint: str
    initialBlack: List[str]
    initialWhite: List[str]

class ProblemDetail(BaseModel):
    id: str
    level: str
    category: str
    hint: str
    boardSize: int
    initialBlack: List[str]
    initialWhite: List[str]
    sgfContent: str

class ProgressData(BaseModel):
    odId: str
    completed: bool
    attempts: int
    firstCompletedAt: Optional[str]
    lastAttemptAt: Optional[str]
    lastDuration: Optional[int]

class ProgressUpdate(BaseModel):
    completed: bool
    attempts: int
    lastDuration: Optional[int]


def load_index() -> dict:
    """Load index.json file."""
    if not INDEX_FILE.exists():
        raise HTTPException(status_code=500, detail="Index file not found. Run generate_tsumego_index.py")
    with open(INDEX_FILE, "r", encoding="utf-8") as f:
        return json.load(f)


@router.get("/levels", response_model=List[LevelInfo])
def get_levels():
    """Get all available difficulty levels with category counts."""
    index = load_index()
    result = []
    for level, data in sorted(index["levels"].items()):
        categories = {cat: len(ids) for cat, ids in data["categories"].items()}
        result.append(LevelInfo(
            level=level,
            categories=categories,
            total=sum(categories.values())
        ))
    return result


@router.get("/levels/{level}/categories", response_model=List[CategoryInfo])
def get_categories(level: str):
    """Get categories for a specific difficulty level."""
    index = load_index()
    if level not in index["levels"]:
        raise HTTPException(status_code=404, detail=f"Level {level} not found")

    category_names = {
        "life-death": "死活题",
        "tesuji": "手筋题",
        "endgame": "官子题"
    }

    result = []
    for cat, ids in index["levels"][level]["categories"].items():
        result.append(CategoryInfo(
            category=cat,
            name=category_names.get(cat, cat),
            count=len(ids)
        ))
    return result


@router.get("/levels/{level}/categories/{category}", response_model=List[ProblemSummary])
def get_problems(
    level: str,
    category: str,
    offset: int = Query(0, ge=0),
    limit: int = Query(20, ge=1, le=100)
):
    """Get problems for a level/category with pagination."""
    index = load_index()

    if level not in index["levels"]:
        raise HTTPException(status_code=404, detail=f"Level {level} not found")

    categories = index["levels"][level]["categories"]
    if category not in categories:
        raise HTTPException(status_code=404, detail=f"Category {category} not found")

    problem_ids = categories[category][offset:offset + limit]

    result = []
    for pid in problem_ids:
        p = index["problems"].get(pid)
        if p:
            result.append(ProblemSummary(
                id=p["id"],
                level=p["level"],
                category=p["category"],
                hint=p["hint"],
                initialBlack=p["initialBlack"],
                initialWhite=p["initialWhite"]
            ))
    return result


@router.get("/problems/{problem_id}", response_model=ProblemDetail)
def get_problem(problem_id: str, db: Session = Depends(get_db)):
    """Get full problem details including SGF content."""
    problem = db.query(TsumegoProblem).filter(TsumegoProblem.id == problem_id).first()
    if not problem:
        raise HTTPException(status_code=404, detail=f"Problem {problem_id} not found")

    return ProblemDetail(
        id=problem.id,
        level=problem.level,
        category=problem.category,
        hint=problem.hint,
        boardSize=problem.board_size,
        initialBlack=problem.initial_black or [],
        initialWhite=problem.initial_white or [],
        sgfContent=problem.sgf_content or ""
    )


@router.get("/progress", response_model=dict[str, ProgressData])
def get_progress(
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Get current user's progress on all problems."""
    progress_list = db.query(UserTsumegoProgress).filter(
        UserTsumegoProgress.user_id == user.id
    ).all()

    result = {}
    for p in progress_list:
        result[p.problem_id] = ProgressData(
            odId=p.problem_id,
            completed=p.completed,
            attempts=p.attempts,
            firstCompletedAt=p.first_completed_at.isoformat() if p.first_completed_at else None,
            lastAttemptAt=p.last_attempt_at.isoformat() if p.last_attempt_at else None,
            lastDuration=p.last_duration
        )
    return result


@router.post("/progress/{problem_id}")
def update_progress(
    problem_id: str,
    data: ProgressUpdate,
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Update user's progress on a specific problem."""
    from datetime import datetime

    progress = db.query(UserTsumegoProgress).filter(
        UserTsumegoProgress.user_id == user.id,
        UserTsumegoProgress.problem_id == problem_id
    ).first()

    now = datetime.utcnow()

    if progress:
        progress.completed = data.completed
        progress.attempts = data.attempts
        progress.last_attempt_at = now
        if data.lastDuration is not None:
            progress.last_duration = data.lastDuration
        if data.completed and not progress.first_completed_at:
            progress.first_completed_at = now
    else:
        progress = UserTsumegoProgress(
            user_id=user.id,
            problem_id=problem_id,
            completed=data.completed,
            attempts=data.attempts,
            last_attempt_at=now,
            last_duration=data.lastDuration,
            first_completed_at=now if data.completed else None
        )
        db.add(progress)

    db.commit()
    return {"success": True}
```

**Step 2: Register router in api.py**

Add to `katrain/web/api/v1/api.py`:
```python
from katrain.web.api.v1.endpoints import tsumego

api_router.include_router(tsumego.router, prefix="/tsumego", tags=["tsumego"])
```

**Step 3: Test endpoints**

Run: `curl http://localhost:8001/api/v1/tsumego/levels`
Expected: JSON array of levels

**Step 4: Commit**

```bash
git add katrain/web/api/v1/endpoints/tsumego.py katrain/web/api/v1/api.py
git commit -m "feat: add tsumego API endpoints"
```

---

## Phase 2: Frontend - Problem Browsing

### Task 2.1: Add Sidebar Menu Item

**Files:**
- Modify: `katrain/web/ui/src/galaxy/components/layout/GalaxySidebar.tsx`
- Modify: `katrain/web/ui/src/i18n/index.ts` (add translations)

**Step 1: Add Tsumego to menu items**

In `GalaxySidebar.tsx`, add to menuItems array:
```typescript
import ExtensionIcon from '@mui/icons-material/Extension'; // or a puzzle icon

const menuItems = [
  { text: i18n.t('btn:Play', 'Play'), icon: <SportsEsportsIcon />, path: '/galaxy/play', disabled: false },
  { text: i18n.t('Research', 'Research'), icon: <ScienceIcon />, path: '/galaxy/research', disabled: false },
  { text: i18n.t('Tsumego', '死活题'), icon: <ExtensionIcon />, path: '/galaxy/tsumego', disabled: false }, // NEW
  { text: i18n.t('analysis:report', 'Report'), icon: <AssessmentIcon />, path: '/galaxy/report', disabled: true },
  { text: i18n.t('Live', 'Live'), icon: <LiveTvIcon />, path: '/galaxy/live', disabled: true },
];
```

**Step 2: Add i18n key**

Add "Tsumego" translations to all language files.

**Step 3: Commit**

```bash
git add katrain/web/ui/src/galaxy/components/layout/GalaxySidebar.tsx
git commit -m "feat: add Tsumego menu item to Galaxy sidebar"
```

---

### Task 2.2: Create Level Selection Page

**Files:**
- Create: `katrain/web/ui/src/galaxy/pages/TsumegoLevelsPage.tsx`

**Step 1: Write the component**

```typescript
import { useState, useEffect } from 'react';
import { Box, Typography, Grid, Card, CardContent, CardActionArea, CircularProgress } from '@mui/material';
import { useNavigate } from 'react-router-dom';
import { i18n } from '../../i18n';

interface LevelInfo {
  level: string;
  categories: Record<string, number>;
  total: number;
}

const TsumegoLevelsPage = () => {
  const navigate = useNavigate();
  const [levels, setLevels] = useState<LevelInfo[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/v1/tsumego/levels')
      .then(res => res.json())
      .then(data => {
        setLevels(data);
        setLoading(false);
      })
      .catch(err => {
        console.error('Failed to load levels:', err);
        setLoading(false);
      });
  }, []);

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      <Typography variant="h4" gutterBottom>
        {i18n.t('Tsumego', '死活题')}
      </Typography>
      <Typography variant="body1" color="text.secondary" sx={{ mb: 3 }}>
        {i18n.t('tsumego:selectLevel', '选择难度级别')}
      </Typography>

      <Grid container spacing={2}>
        {levels.map((level) => (
          <Grid item xs={6} sm={4} md={3} key={level.level}>
            <Card
              sx={{
                bgcolor: 'rgba(255,255,255,0.05)',
                '&:hover': { bgcolor: 'rgba(255,255,255,0.08)' }
              }}
            >
              <CardActionArea onClick={() => navigate(`/galaxy/tsumego/${level.level}`)}>
                <CardContent sx={{ textAlign: 'center', py: 3 }}>
                  <Typography variant="h5" sx={{ fontWeight: 'bold', color: '#e89639' }}>
                    {level.level.toUpperCase()}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {level.total} {i18n.t('tsumego:problems', '题')}
                  </Typography>
                </CardContent>
              </CardActionArea>
            </Card>
          </Grid>
        ))}
      </Grid>
    </Box>
  );
};

export default TsumegoLevelsPage;
```

**Step 2: Commit**

```bash
git add katrain/web/ui/src/galaxy/pages/TsumegoLevelsPage.tsx
git commit -m "feat: add TsumegoLevelsPage component"
```

---

### Task 2.3: Create Category Selection Page

**Files:**
- Create: `katrain/web/ui/src/galaxy/pages/TsumegoCategoriesPage.tsx`

**Step 1: Write the component**

```typescript
import { useState, useEffect } from 'react';
import { Box, Typography, Grid, Card, CardContent, CardActionArea, CircularProgress, IconButton } from '@mui/material';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import { useNavigate, useParams } from 'react-router-dom';
import { i18n } from '../../i18n';

interface CategoryInfo {
  category: string;
  name: string;
  count: number;
}

const TsumegoCategoriesPage = () => {
  const navigate = useNavigate();
  const { level } = useParams<{ level: string }>();
  const [categories, setCategories] = useState<CategoryInfo[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch(`/api/v1/tsumego/levels/${level}/categories`)
      .then(res => res.json())
      .then(data => {
        setCategories(data);
        setLoading(false);
      })
      .catch(err => {
        console.error('Failed to load categories:', err);
        setLoading(false);
      });
  }, [level]);

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
        <IconButton onClick={() => navigate('/galaxy/tsumego')} sx={{ mr: 1 }}>
          <ArrowBackIcon />
        </IconButton>
        <Typography variant="h4">
          {level?.toUpperCase()} - {i18n.t('tsumego:selectCategory', '选择题型')}
        </Typography>
      </Box>

      <Grid container spacing={2}>
        {categories.map((cat) => (
          <Grid item xs={6} sm={4} md={3} key={cat.category}>
            <Card
              sx={{
                bgcolor: 'rgba(255,255,255,0.05)',
                '&:hover': { bgcolor: 'rgba(255,255,255,0.08)' }
              }}
            >
              <CardActionArea onClick={() => navigate(`/galaxy/tsumego/${level}/${cat.category}`)}>
                <CardContent sx={{ textAlign: 'center', py: 3 }}>
                  <Typography variant="h6" sx={{ fontWeight: 'bold' }}>
                    {cat.name}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {cat.count} {i18n.t('tsumego:problems', '题')}
                  </Typography>
                </CardContent>
              </CardActionArea>
            </Card>
          </Grid>
        ))}
      </Grid>
    </Box>
  );
};

export default TsumegoCategoriesPage;
```

**Step 2: Commit**

```bash
git add katrain/web/ui/src/galaxy/pages/TsumegoCategoriesPage.tsx
git commit -m "feat: add TsumegoCategoriesPage component"
```

---

### Task 2.4: Create MiniBoard Component

**Files:**
- Create: `katrain/web/ui/src/galaxy/components/tsumego/MiniBoard.tsx`

**Step 1: Write the component**

```typescript
import { useMemo } from 'react';
import { Box } from '@mui/material';

interface MiniBoardProps {
  size?: number;  // Canvas size in pixels
  boardSize?: number;  // Go board size (9, 13, 19)
  blackStones: string[];  // SGF coords like ["pa", "rd"]
  whiteStones: string[];
}

// Convert SGF coordinate to [x, y]
function sgfToCoord(sgf: string, boardSize: number): [number, number] {
  const SGF_COORD = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const x = SGF_COORD.indexOf(sgf[0]);
  const y = boardSize - 1 - SGF_COORD.indexOf(sgf[1]);
  return [x, y];
}

// Find bounding box of stones with padding
function getBoundingBox(blacks: string[], whites: string[], boardSize: number, padding: number = 2) {
  const allCoords = [...blacks, ...whites].map(s => sgfToCoord(s, boardSize));
  if (allCoords.length === 0) {
    return { minX: 0, maxX: boardSize - 1, minY: 0, maxY: boardSize - 1 };
  }

  let minX = Math.min(...allCoords.map(c => c[0]));
  let maxX = Math.max(...allCoords.map(c => c[0]));
  let minY = Math.min(...allCoords.map(c => c[1]));
  let maxY = Math.max(...allCoords.map(c => c[1]));

  // Add padding
  minX = Math.max(0, minX - padding);
  maxX = Math.min(boardSize - 1, maxX + padding);
  minY = Math.max(0, minY - padding);
  maxY = Math.min(boardSize - 1, maxY + padding);

  return { minX, maxX, minY, maxY };
}

const MiniBoard = ({ size = 100, boardSize = 19, blackStones, whiteStones }: MiniBoardProps) => {
  const { minX, maxX, minY, maxY } = useMemo(
    () => getBoundingBox(blackStones, whiteStones, boardSize),
    [blackStones, whiteStones, boardSize]
  );

  const visibleWidth = maxX - minX + 1;
  const visibleHeight = maxY - minY + 1;
  const cellSize = size / Math.max(visibleWidth, visibleHeight);
  const stoneRadius = cellSize * 0.45;

  const blackCoords = useMemo(
    () => blackStones.map(s => sgfToCoord(s, boardSize)),
    [blackStones, boardSize]
  );
  const whiteCoords = useMemo(
    () => whiteStones.map(s => sgfToCoord(s, boardSize)),
    [whiteStones, boardSize]
  );

  return (
    <Box
      sx={{
        width: size,
        height: size,
        bgcolor: '#DEB887',
        borderRadius: 1,
        position: 'relative',
        overflow: 'hidden'
      }}
    >
      <svg width={size} height={size}>
        {/* Grid lines */}
        {Array.from({ length: visibleWidth }).map((_, i) => (
          <line
            key={`v${i}`}
            x1={(i + 0.5) * cellSize}
            y1={cellSize * 0.5}
            x2={(i + 0.5) * cellSize}
            y2={size - cellSize * 0.5}
            stroke="#8B7355"
            strokeWidth={0.5}
          />
        ))}
        {Array.from({ length: visibleHeight }).map((_, i) => (
          <line
            key={`h${i}`}
            x1={cellSize * 0.5}
            y1={(i + 0.5) * cellSize}
            x2={size - cellSize * 0.5}
            y2={(i + 0.5) * cellSize}
            stroke="#8B7355"
            strokeWidth={0.5}
          />
        ))}

        {/* Black stones */}
        {blackCoords.map(([x, y], i) => (
          <circle
            key={`b${i}`}
            cx={(x - minX + 0.5) * cellSize}
            cy={(maxY - y + 0.5) * cellSize}
            r={stoneRadius}
            fill="#1a1a1a"
          />
        ))}

        {/* White stones */}
        {whiteCoords.map(([x, y], i) => (
          <circle
            key={`w${i}`}
            cx={(x - minX + 0.5) * cellSize}
            cy={(maxY - y + 0.5) * cellSize}
            r={stoneRadius}
            fill="#f5f5f5"
            stroke="#333"
            strokeWidth={0.5}
          />
        ))}
      </svg>
    </Box>
  );
};

export default MiniBoard;
```

**Step 2: Commit**

```bash
git add katrain/web/ui/src/galaxy/components/tsumego/MiniBoard.tsx
git commit -m "feat: add MiniBoard component for tsumego thumbnails"
```

---

### Task 2.5: Create Problem Card Component

**Files:**
- Create: `katrain/web/ui/src/galaxy/components/tsumego/ProblemCard.tsx`

**Step 1: Write the component**

```typescript
import { Box, Typography, Card, CardActionArea } from '@mui/material';
import MiniBoard from './MiniBoard';

interface ProblemProgress {
  completed: boolean;
  attempts: number;
  lastDuration?: number;
}

interface ProblemCardProps {
  id: string;
  index: number;
  initialBlack: string[];
  initialWhite: string[];
  progress?: ProblemProgress;
  onClick: () => void;
}

const ProblemCard = ({ id, index, initialBlack, initialWhite, progress, onClick }: ProblemCardProps) => {
  const isCompleted = progress?.completed;
  const isAttempted = progress && progress.attempts > 0;

  // Border color based on status
  const borderColor = isCompleted
    ? '#4caf50'  // green
    : isAttempted
      ? '#e89639'  // orange
      : 'rgba(255,255,255,0.1)';  // gray

  return (
    <Card
      sx={{
        bgcolor: 'rgba(255,255,255,0.05)',
        border: `2px solid ${borderColor}`,
        transition: 'transform 0.2s, box-shadow 0.2s',
        '&:hover': {
          transform: 'scale(1.02)',
          boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
        }
      }}
    >
      <CardActionArea onClick={onClick} sx={{ p: 1 }}>
        <Box sx={{ display: 'flex', justifyContent: 'center', mb: 1 }}>
          <MiniBoard
            size={100}
            blackStones={initialBlack}
            whiteStones={initialWhite}
          />
        </Box>

        <Typography variant="body2" align="center" sx={{ fontWeight: 500 }}>
          第{index + 1}题
        </Typography>

        {/* Progress stats */}
        <Box sx={{ display: 'flex', justifyContent: 'center', gap: 1, mt: 0.5, minHeight: 20 }}>
          {isCompleted && progress?.lastDuration && (
            <Typography variant="caption" sx={{ color: '#e89639' }}>
              ⚡{progress.lastDuration < 60
                ? `${progress.lastDuration}秒`
                : `${Math.floor(progress.lastDuration / 60)}分${progress.lastDuration % 60}秒`}
            </Typography>
          )}
          {progress && progress.attempts > 0 && (
            <Typography variant="caption" sx={{ color: isCompleted ? 'text.secondary' : '#e16b5c' }}>
              ×{progress.attempts}
            </Typography>
          )}
        </Box>
      </CardActionArea>
    </Card>
  );
};

export default ProblemCard;
```

**Step 2: Commit**

```bash
git add katrain/web/ui/src/galaxy/components/tsumego/ProblemCard.tsx
git commit -m "feat: add ProblemCard component with progress display"
```

---

### Task 2.6: Create Problem List Page

**Files:**
- Create: `katrain/web/ui/src/galaxy/pages/TsumegoListPage.tsx`

**Step 1: Write the component**

```typescript
import { useState, useEffect } from 'react';
import { Box, Typography, Grid, CircularProgress, IconButton, Chip } from '@mui/material';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import { useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import ProblemCard from '../components/tsumego/ProblemCard';
import { i18n } from '../../i18n';

interface ProblemSummary {
  id: string;
  level: string;
  category: string;
  hint: string;
  initialBlack: string[];
  initialWhite: string[];
}

interface ProgressData {
  completed: boolean;
  attempts: number;
  lastDuration?: number;
}

const CATEGORY_NAMES: Record<string, string> = {
  'life-death': '死活题',
  'tesuji': '手筋题',
  'endgame': '官子题'
};

const TsumegoListPage = () => {
  const navigate = useNavigate();
  const { level, category } = useParams<{ level: string; category: string }>();
  const { user } = useAuth();

  const [problems, setProblems] = useState<ProblemSummary[]>([]);
  const [progress, setProgress] = useState<Record<string, ProgressData>>({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Load problems
    fetch(`/api/v1/tsumego/levels/${level}/categories/${category}?limit=100`)
      .then(res => res.json())
      .then(data => {
        setProblems(data);
        setLoading(false);
      })
      .catch(err => {
        console.error('Failed to load problems:', err);
        setLoading(false);
      });

    // Load progress from localStorage
    const stored = localStorage.getItem('tsumego_progress');
    if (stored) {
      setProgress(JSON.parse(stored));
    }

    // If logged in, also fetch from server
    if (user) {
      fetch('/api/v1/tsumego/progress', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          setProgress(prev => ({ ...prev, ...data }));
        })
        .catch(console.error);
    }
  }, [level, category, user]);

  const completedCount = problems.filter(p => progress[p.id]?.completed).length;

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
        <IconButton onClick={() => navigate(`/galaxy/tsumego/${level}`)} sx={{ mr: 1 }}>
          <ArrowBackIcon />
        </IconButton>
        <Typography variant="h5" sx={{ flexGrow: 1 }}>
          {level?.toUpperCase()} - {CATEGORY_NAMES[category || ''] || category}
        </Typography>
        <Chip
          label={`${completedCount}/${problems.length}`}
          color={completedCount === problems.length ? 'success' : 'default'}
        />
      </Box>

      <Grid container spacing={2}>
        {problems.map((problem, index) => (
          <Grid item xs={6} sm={4} md={3} lg={2} key={problem.id}>
            <ProblemCard
              id={problem.id}
              index={index}
              initialBlack={problem.initialBlack}
              initialWhite={problem.initialWhite}
              progress={progress[problem.id]}
              onClick={() => navigate(`/galaxy/tsumego/problem/${problem.id}`)}
            />
          </Grid>
        ))}
      </Grid>
    </Box>
  );
};

export default TsumegoListPage;
```

**Step 2: Commit**

```bash
git add katrain/web/ui/src/galaxy/pages/TsumegoListPage.tsx
git commit -m "feat: add TsumegoListPage with problem grid"
```

---

### Task 2.7: Add Routes to GalaxyApp

**Files:**
- Modify: `katrain/web/ui/src/GalaxyApp.tsx`

**Step 1: Import pages and add routes**

```typescript
import TsumegoLevelsPage from './galaxy/pages/TsumegoLevelsPage';
import TsumegoCategoriesPage from './galaxy/pages/TsumegoCategoriesPage';
import TsumegoListPage from './galaxy/pages/TsumegoListPage';
// TsumegoProblemPage will be added in Phase 2

// Add routes inside <Route element={<MainLayout />}>
<Route path="tsumego" element={<TsumegoLevelsPage />} />
<Route path="tsumego/:level" element={<TsumegoCategoriesPage />} />
<Route path="tsumego/:level/:category" element={<TsumegoListPage />} />
```

**Step 2: Test navigation**

Run dev server and navigate through:
- /galaxy/tsumego
- /galaxy/tsumego/3d
- /galaxy/tsumego/3d/life-death

**Step 3: Commit**

```bash
git add katrain/web/ui/src/GalaxyApp.tsx
git commit -m "feat: add tsumego routes to GalaxyApp"
```

---

## Phase 2: Core Solving Experience

### Task 2.8 - 2.15: Problem Solving Page

(Detailed steps for TsumegoProblemPage.tsx with SGF parsing, move validation, guided interaction, undo/redo, progress saving...)

---

## Phase 3: Polish & Enhancements

### Task 3.1: Offline Support with IndexedDB
### Task 3.2: Accessibility - Keyboard Navigation
### Task 3.3: Animations & Sound Effects
### Task 3.4: Mobile Responsive Tweaks

---

## Appendix A: File Checklist

**Scripts:**
- [ ] `scripts/generate_tsumego_index.py`
- [ ] `scripts/sync_tsumego_db.py`

**Backend:**
- [ ] `katrain/web/core/models/tsumego.py`
- [ ] `katrain/web/api/v1/endpoints/tsumego.py`

**Frontend:**
- [ ] `katrain/web/ui/src/galaxy/pages/TsumegoLevelsPage.tsx`
- [ ] `katrain/web/ui/src/galaxy/pages/TsumegoCategoriesPage.tsx`
- [ ] `katrain/web/ui/src/galaxy/pages/TsumegoListPage.tsx`
- [ ] `katrain/web/ui/src/galaxy/pages/TsumegoProblemPage.tsx`
- [ ] `katrain/web/ui/src/galaxy/components/tsumego/MiniBoard.tsx`
- [ ] `katrain/web/ui/src/galaxy/components/tsumego/ProblemCard.tsx`
- [ ] `katrain/web/ui/src/galaxy/components/tsumego/ProblemBoard.tsx`

**Documentation:**
- [ ] `data/life-n-death/README.md`

---

## Update Log

### 2026-01-23: UI Improvements Implementation

**Implemented Features:**

#### 1. Level Sorting by Difficulty
- Added `level_sort_key()` function in `katrain/web/api/v1/endpoints/tsumego.py`
- Levels now display in order: 15K → 14K → ... → 1K → 1D → 2D → ... → 7D (weakest to strongest)

```python
def level_sort_key(level: str) -> tuple:
    """Sort levels: 15K, 14K, ..., 1K, 1D, 2D, ..., 7D (weakest to strongest)."""
    level = level.upper()
    if level.endswith('K'):
        return (0, -int(level[:-1]))  # Kyu: higher number = weaker = first
    elif level.endswith('D'):
        return (1, int(level[:-1]))   # Dan: lower number = weaker = first
    return (2, 0)
```

#### 2. Category Page Redesign
- Redesigned `TsumegoCategoriesPage.tsx` with vertical card layout
- Cards are now left-aligned, stacked vertically with 16px gap
- Each card has: icon (48px) | category name | problem count
- Fixed max-width: 480px per card
- Horizontal content layout prevents text wrapping

**Before:**
```
┌─────┐  ┌─────┐  ┌─────┐
│死活 │  │手筋 │  │官子 │
└─────┘  └─────┘  └─────┘
  (centered grid, text wraps)
```

**After:**
```
┌────────────────────────────────────────────────┐
│  ⚔️    死活                          85 题    │
└────────────────────────────────────────────────┘
┌────────────────────────────────────────────────┐
│  ✨    手筋                          14 题    │
└────────────────────────────────────────────────┘
  (left-aligned, vertical stack, no text wrap)
```

#### 3. Unit Grouping Concept
- Added new navigation layer: Problems are grouped into "units" of 20 problems each
- **New file:** `katrain/web/ui/src/galaxy/pages/TsumegoUnitsPage.tsx`

**Updated Navigation Flow:**
```
/galaxy/tsumego              → Level selection
/galaxy/tsumego/:level       → Category selection
/galaxy/tsumego/:level/:cat  → Units selection (NEW)
/galaxy/tsumego/:level/:cat/:unit → Problem grid (20 problems)
```

**Unit Card Design:**
```
┌──────────────────────────────────────────────────────────────┐
│  单元 1      第 1-20 题                    ●●●○○     3/20   │
└──────────────────────────────────────────────────────────────┘
```

**Progress Dots Logic:**
- 5 dots representing completion percentage
- `●○○○○` = 0-20%, `●●○○○` = 20-40%, etc.
- Completed dots: green (#4caf50), Empty dots: gray (rgba(255,255,255,0.2))

#### 4. Translation Keys Added
New i18n keys added to `.po` files:

| Key | English | Chinese |
|-----|---------|---------|
| `tsumego:selectUnit` | Select Unit | 选择单元 |
| `tsumego:unitDesc` | Total {total} problems in {units} units | 共 {total} 题，分为 {units} 个单元 |
| `tsumego:unit` | Unit | 单元 |
| `tsumego:problemRange` | Problems {start}-{end} | 第 {start}-{end} 题 |

**Files Modified:**
| File | Change |
|------|--------|
| `katrain/web/api/v1/endpoints/tsumego.py` | Added `level_sort_key()` function |
| `katrain/web/ui/src/galaxy/pages/TsumegoCategoriesPage.tsx` | Redesigned vertical layout |
| `katrain/web/ui/src/galaxy/pages/TsumegoUnitsPage.tsx` | **Created** - new units page |
| `katrain/web/ui/src/GalaxyApp.tsx` | Added unit route |
| `katrain/web/ui/src/galaxy/pages/TsumegoListPage.tsx` | Accept unit parameter, show 20 problems |
| `katrain/i18n/locales/*/LC_MESSAGES/katrain.po` | Added new translation keys |
